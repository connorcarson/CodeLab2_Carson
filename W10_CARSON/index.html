<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.19.0/phaser.js"></script>
    <script src2="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.6.2/phaser.js>"></script>
</head>
<body>

    <script>
        var game = new Phaser.Game({
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            backgroundColor: '#272829',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }},
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        });

        function preload ()
        {
           this.load.spritesheet('sm', 'assets/sprites/sm-special-move.png', { frameWidth: 75, frameHeight: 125 });
           this.load.spritesheet('enemy1', 'assets/sprites/enemy1.png', {frameWidth: 75, frameHeight: 125});
           this.load.spritesheet('enemy2', 'assets/sprites/enemy2.png', {frameWidth: 75, frameHeight: 125});
           this.load.spritesheet('enemy3', 'assets/sprites/enemy3.png', {frameWidth: 75, frameHeight: 125});
           this.load.spritesheet('enemy4', 'assets/sprites/enemy4.png', {frameWidth: 75, frameHeight: 125});
           this.load.spritesheet('enemy5', 'assets/sprites/enemy5.png', {frameWidth: 75, frameHeight: 125});
        }

        let sm;
        let enemy1;
        let enemy2;
        let enemy3;
        let enemy4;
        let enemy5;
        let anim;
        let nextFrame;
        let powers;
        let buffer;
        let currentGoal;
        let currentGoalIndex = 0;
        let goalText;

        function create ()
        {
            //frameView = this.add.graphics({ fillStyle: { color: 0xff00ff }, x: 32, y: 32 });

            sm = this.add.sprite(400, 300, 'sm').setScale(2, 2);
            enemy1 = this.physics.add.sprite(550, 250, 'enemy1').setScale(1, 1);
            enemy2 = this.physics.add.sprite(700, 100, 'enemy2').setScale(1, 1);
            enemy3 = this.physics.add.sprite(100, 150, 'enemy3').setScale(1, 1);
            enemy4 = this.physics.add.sprite(200, 350, 'enemy4').setScale(1, 1);
            enemy5 = this.physics.add.sprite(650, 400, 'enemy5').setScale(1, 1);

            nextFrame = 1;

            //is this a prototype?
            var config = {
                key: 'special-move',
                frames: this.anims.generateFrameNumbers('sm', {start: 0, end: 35, first: 0}),
                frameRate: 20,
                yoyo: false,
                repeat: 0
            };

            anim = this.anims.create(config);

            powers =
                    ["moooooooooon tiaaaaraaaaaaaa magic",
                    "mooooooon heeeeaaaaling activation",
                    "cooooosmiiiiic mooooooooooon power",
                    "moooooooooon crystaaaaaaaaal power",
                    "mooooooon scepterrrrrr elimination",
                    "moooooon spiiiralll hearrrt attack",
                    "mooooooon gorgeoussssss meditation"]

            currentGoal = powers[currentGoalIndex].split("");

            goalText = this.add.text(0, 0, powers[currentGoalIndex], { font: "35px Arial", fill: "#ffffff", boundsAlignH: "center", boundsAlignV: "middle" });
            goalText.setPosition(400 - goalText.width/2, 450);
            goalText.setTint(0xff0040, 0xffff00, 0x2602f2, 0xe00b36);

            buffer = [];

            let lastKeyTime = Date.now();

            document.addEventListener('keydown', event => {
                const charList = 'abcdefghijklmnopqrstuvwxyz0123456789 ';
                const key = event.key.toLowerCase();

                // we are only interested in alphanumeric keys
                if (charList.indexOf(key) === -1) return;

                const currentTime = Date.now();
                //1000 is milliseconds here, so 1 full second
                if(currentTime - lastKeyTime > 500){
                    buffer = [];
                    nextFrame = 1;
                    sm.setFrame(0);
                }

                lastKeyTime = currentTime;

                buffer.push(key);

                if(buffer[buffer.length - 1] === currentGoal[buffer.length -1]){
                    console.log("You wrote the next correct character!")
                    nextFrame += 1;
                    sm.setFrame(nextFrame);
                }
                if(arraysMatch(buffer, currentGoal)){
                    console.log("You wrote the correct string!")
                    sm.anims.play('special-move');
                    currentGoalIndex += 1;
                    goalText.setText(powers[currentGoalIndex]);
                    goalText.setPosition(400 - goalText.width/2, 450);
                    currentGoal = powers[currentGoalIndex].split("");
                }
            });

        }

        function update ()
        {
            if(nextFrame >= 35) {nextFrame = 1;}
            if(currentGoalIndex >= powers.length - 1) {currentGoalIndex = 0;}
            karaokeFont();
        }

        function karaokeFont()
        {
            let newText = "";
            for(var i=0; i < goalText.length; i++)
            {
                goalText = this.add.text(0, 0, powers[currentGoalIndex], { font: "35px Arial", fill: "#ff0044", boundsAlignH: "center", boundsAlignV: "middle" });
            }
            goalText.innerHTML = newText;
        }

        var arraysMatch = function (arr1, arr2) {

            // Check if the arrays are the same length
            if (arr1.length !== arr2.length) return false;
            // Check if all items exist and are in the same order
            for (var i = 0; i < arr1.length; i++) {
                if (arr1[i] !== arr2[i]) return false;
            }
            // Otherwise, return true
            return true;
        };

        class Enemy extends Phaser.Physics.Arcade.Sprite {
            constructor(scene, x, y, key, type) {
                super(scene, x, y, key, type);
                this.scene = scene;
                this.x = x;
                this.y = y;

                this.enemy = this.scene.physics.add.sprite(x, y, 'player2', 'tank1');
            }
        }

    </script>

</body>
</html>